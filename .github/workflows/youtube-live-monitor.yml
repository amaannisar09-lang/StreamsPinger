name: YouTube Live Stream Monitor

on:
  workflow_dispatch:
  
jobs:
  check-streams:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check YouTube Live Streams & Notify Telegram + Discord
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          node - <<'EOF'
          const https = require("https");
          const fs = require("fs");

          const YOUTUBE_API_KEY    = process.env.YOUTUBE_API_KEY;
          const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
          const TELEGRAM_CHAT_ID   = process.env.TELEGRAM_CHAT_ID;
          const DISCORD_WEBHOOK_URL = process.env.DISCORD_WEBHOOK_URL;

          const PLAYLIST_IDS = [
            "UUBCb6Ye01QIcOQqn4jXl2cQ",
            "UUqzW7F0gwfgPrzabIi5RCmw",
            "UU1q8Mowrhbbx3WjuX16p8JA",
            "UUybLkSR7bhDO1euayyonllA",
            "UU2TXK9laU5OWK_23zizgVMg",
            "UUIuJ3tEY0U5CRtk5GAt0Z2Q",
            "UU21eaBpzcQdaCQVKjSjKQIw",
            "UUuntlPezO6Ge_9C28TcK1Qg",
            "UUdfhZEs7QeJZ0_rqZVq207g",
            "UUliiFfkk1u60BGrt0bJ4vVA",
          ];

          const NOTIFIED_FILE = "notified.json";

          function get(url) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                let data = "";
                res.on("data", (c) => (data += c));
                res.on("end", () => {
                  try { resolve(JSON.parse(data)); }
                  catch (e) { reject(e); }
                });
              }).on("error", reject);
            });
          }

          function post(url, body) {
            return new Promise((resolve, reject) => {
              const payload = JSON.stringify(body);
              const urlObj = new URL(url);
              const options = {
                hostname: urlObj.hostname,
                path: urlObj.pathname + urlObj.search,
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Content-Length": Buffer.byteLength(payload),
                },
              };
              const req = https.request(options, (res) => {
                let data = "";
                res.on("data", (c) => (data += c));
                res.on("end", () => resolve({ status: res.statusCode, body: data }));
              });
              req.on("error", reject);
              req.write(payload);
              req.end();
            });
          }

          async function sendTelegram(channel, title, url) {
            if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
              console.log("‚è≠Ô∏è  Telegram not configured, skipping.");
              return;
            }
            const esc = (s) => s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const message = `üî¥ <b>${esc(channel)} is LIVE!</b>\n\n<b>${esc(title)}</b>\n\n${url}`;
            const result = await post(
              `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,
              { chat_id: TELEGRAM_CHAT_ID, text: message, parse_mode: "HTML" }
            );
            const parsed = JSON.parse(result.body);
            if (parsed.ok) {
              console.log(`‚úÖ Telegram notified: ${channel} - ${title}`);
              return true;
            } else {
              console.error(`‚ùå Telegram rejected: ${parsed.description}`);
              return false;
            }
          }

          async function sendDiscord(channel, title, url) {
            if (!DISCORD_WEBHOOK_URL) {
              console.log("‚è≠Ô∏è  Discord not configured, skipping.");
              return;
            }
            const result = await post(DISCORD_WEBHOOK_URL, {
              embeds: [
                {
                  title: `üî¥ ${channel} is LIVE!`,
                  description: `**${title}**\n\n${url}`,
                  url: url,
                  color: 0xff0000,
                  timestamp: new Date().toISOString(),
                },
              ],
            });
            // Discord returns 204 No Content on success
            if (result.status === 204 || result.status === 200) {
              console.log(`‚úÖ Discord notified: ${channel} - ${title}`);
              return true;
            } else {
              console.error(`‚ùå Discord rejected (HTTP ${result.status}): ${result.body}`);
              return false;
            }
          }

          (async () => {
            let notified = {};
            if (fs.existsSync(NOTIFIED_FILE)) {
              try { notified = JSON.parse(fs.readFileSync(NOTIFIED_FILE, "utf8")); }
              catch (_) { notified = {}; }
            }

            let newNotifications = 0;

            for (const playlistId of PLAYLIST_IDS) {
              try {
                const playlistUrl =
                  `https://www.googleapis.com/youtube/v3/playlistItems` +
                  `?part=snippet&playlistId=${playlistId}&maxResults=1&key=${YOUTUBE_API_KEY}`;
                const playlistRes = await get(playlistUrl);

                if (!playlistRes.items?.length) continue;

                const videoId = playlistRes.items[0].snippet.resourceId.videoId;

                if (notified[videoId]) {
                  console.log(`‚è≠Ô∏è  Already notified: ${videoId}`);
                  continue;
                }

                const videoUrl =
                  `https://www.googleapis.com/youtube/v3/videos` +
                  `?part=snippet,liveStreamingDetails&id=${videoId}&key=${YOUTUBE_API_KEY}`;
                const videoRes = await get(videoUrl);

                const video = videoRes.items?.[0];
                if (!video) continue;

                const isLive = video.snippet.liveBroadcastContent === "live";

                console.log(`üîç Video ID: ${videoId} | liveBroadcastContent: ${video.snippet.liveBroadcastContent} | Title: ${video.snippet.title}`);

                if (isLive) {
                  const title   = video.snippet.title;
                  const channel = video.snippet.channelTitle;
                  const watchUrl = `https://youtube.com/watch?v=${videoId}`;

                  console.log(`üì§ Sending notifications for: ${channel} - ${title}`);

                  const [telegramOk, discordOk] = await Promise.all([
                    sendTelegram(channel, title, watchUrl),
                    sendDiscord(channel, title, watchUrl),
                  ]);

                  if (telegramOk || discordOk) {
                    notified[videoId] = true;
                    newNotifications++;
                  }

                } else {
                  console.log(`‚è≠Ô∏è  Not live: ${videoId}`);
                }

              } catch (err) {
                console.error(`‚ùå Error for playlist ${playlistId}:`, err.message);
              }
            }

            fs.writeFileSync(NOTIFIED_FILE, JSON.stringify(notified, null, 2));
            console.log(`\n‚úî Checked ${PLAYLIST_IDS.length} playlists | New notifications: ${newNotifications}`);
          })();
          EOF

      - name: Commit notified state
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add notified.json
          git diff --cached --quiet || git commit -m "chore: update notified stream state [skip ci]"
          git push
